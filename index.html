<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Formación CAB</title>
  <style>
    body{
      font-family: Arial, sans-serif;
      background: #e9ecef url('AFA.jpg') center/cover no-repeat fixed;
      margin:0; padding:10px;
      display:flex; flex-direction:column; align-items:center;
    }
    /* Cancha */
    #field{
      position:relative;
      background: url('1137.jpg') center/cover no-repeat;
      width:360px; height:540px;
      border:3px solid #fff; border-radius:10px;
      margin:10px 0; page-break-inside: avoid;
      box-shadow: 0 12px 28px rgba(0,0,0,.18);
    }
    .player-container{
      position:absolute;
      display:flex; flex-direction:column; align-items:center;
      width:60px; cursor:move;
    }
    .player{
      width:60px; height:70px;
      background:url('camiseta.png') center/contain no-repeat;
      display:flex; align-items:flex-end; justify-content:center;
    }
    .player-number{ font-weight:bold; color:black; font-size:14px; margin-bottom:30px; }
    .player-name{
      font-size:10px; font-weight:bold; color:black;
      background:rgba(255,255,255,0.7);
      padding:1px 6px; border-radius:999px; margin-top:4px; text-align:center;
      max-width:100px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }

    /* Banco (2 columnas) */
    #bench{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
      margin-top:10px;
      background: rgba(255,255,255,0.9);
      border: 1px dashed #666; border-radius: 8px; padding: 10px;
      width:100%;
      box-shadow: inset 0 0 0 1px #e5e7eb;
    }
    #bench .player-container{
      position:relative !important;
      left:0 !important; top:0 !important; cursor:default;
      width:auto; 
      display:flex; align-items:center; justify-content:center; flex-direction:column;
    }

    button, input, select{ margin:5px; padding:6px 10px; font-size:14px; }
    .panel{ background:#f8fafc; border-radius:12px; padding:12px; border:1px solid #e5e7eb; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    /* Contenedor de cancha + panel */
    .layout{
      display:flex; gap:24px; align-items:flex-start; flex-wrap:wrap;
      width:100%; max-width:1100px;
    }

    /* Datos del evento bajados 50px */
    #eventData{ margin-top:50px; }

    /* Título visible en pantalla */
    .titulo-select{
      font-size: 24px;
      font-weight: 700;
      border: none;
      background: transparent;
      text-align: center;
      display:block;
      margin: 0 auto 6px;
    }

    @media print{
      /* Forzar fondos/imagenes en PDF (AFA + cancha + camisetas) */
      body{ -webkit-print-color-adjust: exact; print-color-adjust: exact; background: url('AFA.jpg') center/cover no-repeat !important; }
      #field{ background: url('1137.jpg') center/cover no-repeat !important; }
      .player{ background: url('camiseta.png') center/contain no-repeat !important; }

      /* Disposición lado a lado en PDF */
      .layout{
        display:flex !important;
        flex-direction:row !important;
        gap:24px !important;
        align-items:flex-start !important;
        flex-wrap:nowrap !important;
      }

      /* Limitar anchos para entrar en la página */
      #field{ width:360px !important; height:540px !important; }
      .panel-right{ width:360px !important; }

      /* Ocultar UI/formularios y Excel en PDF */
      form, button, #loadFile, .event-form, #excelBlock,
      #excelInput, .titulo-select { display:none !important; }

      .player-container{ page-break-inside: avoid; }
      .panel{ border:0; background:#fff; }
    }
  </style>
</head>
<body>

  <!-- Título (pantalla) -->
  <div>
    <select id="tituloFormacion" class="titulo-select">
      <option value="FORMACION JUVENILES LPF" selected>FORMACION JUVENILES LPF</option>
      <option value="FORMACION JUVENILES LCF">FORMACION JUVENILES LCF</option>
      <option value="FORMACION FEMENINO">FORMACION FEMENINO</option>
    </select>
  </div>

  <!-- Resumen -->
  <div id="eventData"></div>

  <!-- Form de evento (no se imprime) -->
  <div class="event-form panel" style="max-width:980px;">
    <div class="row">
      <select id="categoriaSelect">
        <option value="">Seleccione Categoría</option>
        <option value="reserva">Reserva</option>
        <option value="cuarta">Cuarta</option>
        <option value="quinta">Quinta</option>
        <option value="sexta">Sexta</option>
        <option value="septima">Séptima</option>
        <option value="octava">Octava</option>
        <option value="novena">Novena</option>
      </select>

      <select id="NFecha">
        <option value="">Seleccione N° Fecha</option>
        <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
        <option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
        <option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option>
        <option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option>
        <option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option>
      </select>

      <input type="date" id="fechaEncuentro">
      <input type="time" id="horaEncuentro">

      <select id="rivalSelect">
        <option value="">Seleccione Rival</option>
        <option value="River Plate">River Plate</option>
        <option value="Boca Juniors">Boca Juniors</option>
        <option value="Racing Club">Racing Club</option>
        <option value="San Lorenzo">San Lorenzo</option>
        <option value="Independiente">Independiente</option>
      </select>
    </div>

    <!-- Condición -->
    <div class="row" style="margin-top:6px;">
      <label><input type="radio" name="condicion" id="condLocal" value="local" checked /> Local</label>
      <label><input type="radio" name="condicion" id="condVisitante" value="visitante" /> Visitante</label>
    </div>

    <!-- Predio LOCAL -->
    <div id="predioLocalWrap" class="row" style="margin-top:6px;">
      <select id="predioLocal">
        <option value="">Seleccione Predio (Local)</option>
        <option value="Julio César Villagra">Julio César Villagra</option>
        <option value="Predio Armando Pérez">Predio Armando Pérez</option>
      </select>
    </div>

    <!-- Predio VISITANTE -->
    <div id="predioVisitanteWrap" class="row" style="display:none; margin-top:6px;">
      <input type="text" id="predioVisitante" placeholder="Predio / Cancha del rival" />
    </div>

    <!-- Formación -->
    <div class="row">
      <select id="formationSelect">
        <option value="4-4-2">4-4-2</option>
        <option value="4-4-1-1">4-4-1-1</option>
        <option value="4-3-1-2">4-3-1-2</option>
        <option value="4-1-3-2">4-1-3-2</option>
        <option value="4-3-3">4-3-3</option>
        <option value="4-1-4-1">4-1-4-1</option>
        <option value="4-2-3-1">4-2-3-1</option>
        <option value="3-4-1-2">3-4-1-2</option>
        <option value="3-4-3">3-4-3</option>
        <option value="3-5-2">3-5-2</option>
        <option value="5-3-2">5-3-2</option>
      </select>

      <button type="button" id="guardarEvento">Guardar Evento</button>
    </div>
  </div>

  <!-- Form jugadores (no se imprime) -->
  <form id="playerForm" class="panel" style="max-width:980px; margin-top:10px;">
    <h3>Formación del Partido</h3>
    <div class="row">
      <input list="playerNames" id="name" placeholder="Nombre" required />
      <datalist id="playerNames"></datalist>
      <input type="number" id="number" placeholder="N°" required />
      <select id="position">
        <option value="titular">Titular</option>
        <option value="suplente">Suplente</option>
      </select>
    </div>
    <div class="row">
      <button type="submit">Agregar</button>
      <button type="button" onclick="resetPositions()">Resetear Posiciones</button>
      <button type="button" onclick="applyFormation()">Aplicar Formación</button>
      <button type="button" onclick="saveFormation()">Guardar</button>
      <button type="button" onclick="loadFormation()">Cargar</button>
      <button type="button" onclick="exportPDF()">Exportar a PDF</button>
      <button type="button" onclick="sendWhatsApp()">WhatsApp</button>
      <input type="file" id="loadFile" style="display:none" />
    </div>
  </form>

  <!-- Cancha + Panel derecho (quedarán lado a lado en PDF) -->
  <div class="layout">
    <div id="field"></div>

    <!-- Panel lateral -->
    <div class="panel panel-right" style="min-width:320px; max-width:520px;">
      <h3 class="ct-header">Cuerpo Técnico</h3>
      <div id="cuerpoTecnicoValores" style="margin-top:8px; font-size:14px; line-height:1.6;">
        <p><strong>DT:</strong> <span id="dt">—</span></p>
        <p><strong>AC:</strong> <span id="ac">—</span></p>
        <p><strong>PF:</strong> <span id="pf">—</span></p>
      </div>

      <!-- Banco debajo del CT -->
      <h3 style="margin-top:12px;">Suplentes</h3>
      <div id="bench"></div>

      <!-- Excel visible en pantalla / oculto en PDF -->
      <div id="excelBlock" style="margin-top:12px;">
        <hr />
        <h3>Listado de jugadores (Excel)</h3>
        <div class="row">
          <input type="file" id="excelInput" accept=".xlsx,.xls" />
        </div>
        <div id="excelStatus" style="font-size:13px; opacity:.8;"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    // ================== Estado ==================
    let eventInfo = { categoria:"", nFecha:"", fecha:"", hora:"", rival:"", formacion:"", condicion:"local", predio:"" };
    let players = [];

    // ================== Cuerpo técnico ==================
    const cuerpoTecnicoPorCategoria = {
      reserva: { dt: "Norberto Fernández", ac: "Leonardo Felicia", pf: "Dino Mazzaforte" },
      cuarta:  { dt: "Leandro Zulueta",    ac: "S/D",             pf: "Alejandro Sabattini" },
      quinta:  { dt: "Julio Lopéz",        ac: "Lautaro Olivera", pf: "Cristian Monteverde" },
      sexta:   { dt: "Daniel Mercado",     ac: "Franco Amaya",    pf: "Roberto Miranda" },
      septima: { dt: "Leonardo Torres",    ac: "Juan Quiroga",    pf: "Ayrton Lewandoski" },
      octava:  { dt: "Lucas Sosa",         ac: "Kevin Constantín",pf: "Lucas Nieva" },
      novena:  { dt: "Lucas Rico",         ac: "Américo Ozán",    pf: "Adrián Peralta" },
    };
    function actualizarCuerpoTecnico(cat){
      const key=(cat||"").toLowerCase();
      const t=cuerpoTecnicoPorCategoria[key];
      document.getElementById("dt").textContent=t?t.dt:"—";
      document.getElementById("ac").textContent=t?t.ac:"—";
      document.getElementById("pf").textContent=t?t.pf:"—";
    }
    const categoriaSelectEl = document.getElementById("categoriaSelect");
    categoriaSelectEl.addEventListener("change",e=>{
      actualizarCuerpoTecnico(e.target.value);
      eventInfo.categoria = e.target.value || "";
      pintarResumen();
    });

    // ================== Condición local/visitante ==================
    const condLocal=document.getElementById("condLocal");
    const condVisitante=document.getElementById("condVisitante");
    const predioLocalWrap=document.getElementById("predioLocalWrap");
    const predioVisitanteWrap=document.getElementById("predioVisitanteWrap");
    function actualizarVisibilidadPredio(){
      if(condLocal.checked){ predioLocalWrap.style.display='block'; predioVisitanteWrap.style.display='none'; eventInfo.condicion="local"; }
      else { predioLocalWrap.style.display='none'; predioVisitanteWrap.style.display='block'; eventInfo.condicion="visitante"; }
      pintarResumen();
    }
    condLocal.addEventListener("change",actualizarVisibilidadPredio);
    condVisitante.addEventListener("change",actualizarVisibilidadPredio);
    actualizarVisibilidadPredio();

    // ================== Guardar Evento (resumen) ==================
    document.getElementById("guardarEvento").addEventListener("click",function(){
      const categoria=categoriaSelectEl.value||"";
      const NFecha=document.getElementById("NFecha").value||"";
      const rival=document.getElementById("rivalSelect").value||"";
      const fechaRaw=document.getElementById("fechaEncuentro").value||"";
      const hora=document.getElementById("horaEncuentro").value||"";
      const formacion=document.getElementById("formationSelect").value||"";
      const condicion=document.querySelector('input[name="condicion"]:checked')?.value||"local";
      let predio="";
      if(condicion==="local"){
        predio=document.getElementById("predioLocal").value||""; if(!predio){alert("Seleccioná el predio (Local)."); return;}
      } else {
        predio=document.getElementById("predioVisitante").value.trim(); if(!predio){alert("Ingresá el predio del rival."); return;}
      }
      let fecha=""; if(fechaRaw){const [y,m,d]=fechaRaw.split("-"); fecha=`${d}/${m}/${y}`;}

      actualizarCuerpoTecnico(categoria);

      eventInfo={categoria,nFecha:NFecha,fecha,hora,rival,formacion,condicion,predio};
      pintarResumen();
    });

    // ===== Resumen unificado =====
    function pintarResumen(){
      const titulo = (document.getElementById("tituloFormacion")?.value || "").toUpperCase();
      const cont = document.getElementById("eventData");
      cont.innerHTML = `
        <div style="display:flex; flex-wrap:wrap; gap:12px;">
          <div><strong>Título:</strong> ${titulo || "—"}</div>
          <div><strong>Fecha N°:</strong> ${eventInfo.nFecha||"—"}</div>
          <div><strong>Día:</strong> ${eventInfo.fecha||"—"}</div>
          <div><strong>Hora:</strong> ${eventInfo.hora||"—"}</div>
          <div><strong>Condición:</strong> ${eventInfo.condicion||"—"}</div>
          <div><strong>Predio:</strong> ${eventInfo.predio||"—"}</div>
          <div><strong>Categoría:</strong> ${eventInfo.categoria||"—"}</div>
          <div><strong>Rival:</strong> ${eventInfo.rival||"—"}</div>
          <div><strong>Formación:</strong> ${eventInfo.formacion||"—"}</div>
        </div>`;
    }
    document.getElementById("tituloFormacion").addEventListener("change", pintarResumen);
    document.getElementById("NFecha").addEventListener("change", e => { eventInfo.nFecha = e.target.value; pintarResumen(); });
    document.getElementById("fechaEncuentro").addEventListener("change", e => {
      const v = e.target.value || "";
      eventInfo.fecha = v ? (([y,m,d]=v.split("-")), `${d}/${m}/${y}`) : "";
      pintarResumen();
    });
    document.getElementById("horaEncuentro").addEventListener("change", e => { eventInfo.hora = e.target.value; pintarResumen(); });
    document.getElementById("rivalSelect").addEventListener("change", e => { eventInfo.rival = e.target.value; pintarResumen(); });
    document.getElementById("predioLocal").addEventListener("change", e => { if(eventInfo.condicion==="local"){ eventInfo.predio = e.target.value; pintarResumen(); } });
    document.getElementById("predioVisitante").addEventListener("input", e => { if(eventInfo.condicion==="visitante"){ eventInfo.predio = e.target.value.trim(); pintarResumen(); } });
    document.getElementById("formationSelect").addEventListener("change", e => { eventInfo.formacion = e.target.value; pintarResumen(); });

    // ================== Jugadores (drag y render) ==================
    const field=document.getElementById("field");
    const bench=document.getElementById("bench");
    const form=document.getElementById("playerForm");
    const formationSelectEl=document.getElementById("formationSelect");
    const loadFile=document.getElementById("loadFile");

    form.addEventListener("submit",function(e){
      e.preventDefault();
      const name=document.getElementById("name").value.trim();
      const number=document.getElementById("number").value.trim();
      const position=document.getElementById("position").value;
      if(!name||!number) return;
      if(position==="titular" && players.filter(p=>p.position==="titular").length>=11){ alert("Máx 11 titulares"); return; }
      if(position==="suplente" && players.filter(p=>p.position==="suplente").length>=10){ alert("Máx 10 suplentes"); return; }
      if(players.some(p=>p.number===number)){ alert("Número repetido"); return; }
      players.push({name,number,x:0,y:0,position});
      renderPlayers(); form.reset();
    });

    function renderPlayers(){
      field.innerHTML=""; bench.innerHTML="";
      players.forEach(player=>{
        const c=document.createElement("div"); c.className="player-container";
        const camiseta=document.createElement("div"); camiseta.className="player";
        const num=document.createElement("div"); num.className="player-number"; num.textContent=player.number;
        camiseta.appendChild(num);
        const name=document.createElement("div"); name.className="player-name"; name.contentEditable=true; name.textContent=player.name;
        name.addEventListener("input",()=>player.name=name.textContent);
        c.appendChild(camiseta); c.appendChild(name);
        if(player.position==="titular"){
          c.style.left=player.x+"px"; c.style.top=player.y+"px";
          makeDraggable(c,player);
          field.appendChild(c);
        } else {
          c.style.position="relative"; c.style.left="0px"; c.style.top="0px";
          bench.appendChild(c);
        }
      });
    }

    function makeDraggable(el,playerData){
      let isDragging=false, offsetX=0, offsetY=0;
      el.addEventListener("mousedown",(e)=>{ isDragging=true; offsetX=e.offsetX; offsetY=e.offsetY; });
      document.addEventListener("mousemove",(e)=>{
        if(!isDragging) return;
        const rect=field.getBoundingClientRect();
        let x=e.clientX-rect.left-offsetX, y=e.clientY-rect.top-offsetY;
        x=Math.max(0,Math.min(x,rect.width-el.offsetWidth));
        y=Math.max(0,Math.min(y,rect.height-el.offsetHeight));
        el.style.left=x+"px"; el.style.top=y+"px";
        playerData.x=x; playerData.y=y;
      });
      document.addEventListener("mouseup",()=>{ isDragging=false; });
    }

    function applyFormation(){
      const valores = formationSelectEl.value.split("-").map(n=>parseInt(n,10)).filter(n=>!isNaN(n));
      const titulares = players.filter(p=>p.position==="titular");
      const total = 1 + valores.reduce((a,b)=>a+b,0); // 1 arquero
      if(titulares.length<total){ alert(`Faltan jugadores para ${formationSelectEl.value} + arquero.`); return; }

      const lines=[{count:1,y:440}]; // arquero
      const L=valores.length, bottom=360, top=80, step=L>1? (bottom-top)/(L-1):0;
      for(let i=0;i<L;i++){ lines.push({count:valores[i], y: bottom - i*step}); }

      let i=0;
      lines.forEach(line=>{
        const spacing=360/(line.count+1);
        for(let j=0;j<line.count && i<titulares.length;j++,i++){
          const p=titulares[i];
          p.x=spacing*(j+1)-30;
          p.y=line.y;
        }
      });
      renderPlayers();
    }
    window.applyFormation=applyFormation;

    function saveFormation(){
      const blob=new Blob([JSON.stringify(players)],{type:"application/json"});
      const a=document.createElement("a");
      a.href=URL.createObjectURL(blob);
      a.download="formacion.json";
      a.click();
    }
    function loadFormation(){ loadFile.click(); }
    loadFile.addEventListener("change",(e)=>{
      const f=e.target.files[0]; if(!f) return;
      const r=new FileReader();
      r.onload=(ev)=>{ try{ players=JSON.parse(ev.target.result);}catch{players=[];} renderPlayers(); };
      r.readAsText(f);
    });
    function resetPositions(){ players.forEach(p=>{ if(p.position==="titular"){ p.x=0; p.y=0; } }); renderPlayers(); }
    window.saveFormation=saveFormation; window.loadFormation=loadFormation; window.resetPositions=resetPositions;

    // ================== Exportar a PDF ==================
    function exportPDF(){ window.print(); }
    window.exportPDF = exportPDF;

    // ================== WhatsApp ==================
    function sendWhatsApp(){
      const titulo = (document.getElementById("tituloFormacion")?.value || "FORMACION").toUpperCase();
      let lines=[];
      lines.push(`*${titulo}*`);
      lines.push("");
      lines.push(`*Fecha N°:* ${eventInfo.nFecha||"—"}`);
      lines.push(`*Día:* ${eventInfo.fecha||"—"}`);
      lines.push(`*Hora:* ${eventInfo.hora||"—"}`);
      lines.push(`*Condición:* ${eventInfo.condicion||"—"}`);
      lines.push(`*Predio:* ${eventInfo.predio||"—"}`);
      lines.push(`*Categoría:* ${eventInfo.categoria||"—"}`);
      lines.push(`*Rival:* ${eventInfo.rival||"—"}`);
      lines.push(`*Formación:* ${eventInfo.formacion||"—"}`);
      lines.push("");
      lines.push("*TITULARES:*");
      const titulares=players.filter(p=>p.position==="titular");
      if(titulares.length) titulares.forEach(p=>lines.push(`• ${p.number} - ${p.name}`)); else lines.push("—");
      lines.push("");
      lines.push("*SUPLENTES:*");
      const suplentes=players.filter(p=>p.position==="suplente");
      if(suplentes.length) suplentes.forEach(p=>lines.push(`• ${p.number} - ${p.name}`)); else lines.push("—");
      // Cuerpo técnico
      const dt = (document.getElementById("dt")?.innerText || "").trim();
      const ac = (document.getElementById("ac")?.innerText || "").trim();
      const pf = (document.getElementById("pf")?.innerText || "").trim();
      if (dt || ac || pf) {
        lines.push("");
        lines.push("*Cuerpo Técnico:*");
        if (dt) lines.push(`• DT: ${dt}`);
        if (ac) lines.push(`• AC: ${ac}`);
        if (pf) lines.push(`• PF: ${pf}`);
      }
      const text=lines.join("\n");
      window.open("https://wa.me/?text="+encodeURIComponent(text),"_blank");
    }
    window.sendWhatsApp=sendWhatsApp;

    // ================== Excel (autocompletar nombres) ==================
    const excelInput  = document.getElementById('excelInput');
    const excelStatus = document.getElementById('excelStatus');
    const datalist    = document.getElementById('playerNames');

    function makeDisplayName(row){
      const posibles = {
        nombre:   row['Nombre'] || row['NOMBRE'] || row['name'] || row['Name'],
        apellido: row['Apellido'] || row['APELLIDO'] || row['lastname'] || row['Last Name'] || row['Apellido/s'] || row['Apellidos'],
        jugador:  row['Jugador'] || row['JUGADOR'] || row['player'] || row['Player']
      };
      if (posibles.jugador && String(posibles.jugador).trim()) return String(posibles.jugador).trim();
      const n = posibles.nombre ? String(posibles.nombre).trim() : '';
      const a = posibles.apellido ? String(posibles.apellido).trim() : '';
      if (n && a) return `${n} ${a}`;
      if (n) return n;
      if (a) return a;
      for (const k in row) { const v=row[k]; if (v && String(v).trim()) return String(v).trim(); }
      return '';
    }
    function poblarDatalist(nombres){
      datalist.innerHTML = '';
      const unicos = Array.from(new Set(nombres.filter(Boolean)));
      unicos.sort((a,b)=>a.localeCompare(b,'es'));
      unicos.forEach(n => { const opt=document.createElement('option'); opt.value=n; datalist.appendChild(opt); });
    }

    if (excelInput){
      excelInput.addEventListener('change', function(){
        const file = excelInput.files && excelInput.files[0];
        if (!file){ if (excelStatus) excelStatus.textContent = ''; return; }
        if (excelStatus) excelStatus.textContent = 'Procesando...';

        file.arrayBuffer().then(data=>{
          const wb = XLSX.read(data, { type:'array' });
          const sheetName = wb.SheetNames[0];
          const sheet = wb.Sheets[sheetName];

          const rows = XLSX.utils.sheet_to_json(sheet, { defval:'', raw:false, header:1 });
          const headers = (rows[0] || []).map(h => String(h).trim());
          const objs = rows.slice(1).map(r => { const o={}; headers.forEach((h,i)=>o[h]=r[i]); return o; });

          const nombres = objs.map(row => makeDisplayName(row)).filter(Boolean);
          poblarDatalist(nombres);
          if (excelStatus) excelStatus.textContent = `Cargados ${nombres.length} jugadores.`;
        }).catch(err=>{
          console.error(err);
          if (excelStatus) excelStatus.textContent = 'Error al leer el Excel. Usá .xlsx/.xls con encabezados en la primera fila.';
        });
      });
    }

    // Resumen inicial
    pintarResumen();
  </script>
</body>
</html>
